#!/bin/sh -e

venv_path="@VENV_PATH@"
wheel_name="@WHEEL_NAME@"
wheel_version="@WHEEL_VERSION@"
symlinks="@SYMLINKS@"
symlinks_source_dir=${venv_path}/bin
symlinks_target_dir="@SYMLINKS_TARGET_DIR@"
allow_downloads="@ALLOW_DOWNLOADS@"
verbose="@VERBOSE@"

venv_argss=
install_args=

if ! ${verbose:-false}
then
    venv_args="--quiet"
    install_args="--quiet"
fi

if ! ${allow_downloads:-false}
then
    install_args="${install_args} --no-index"
fi

for dir in @WHEEL_INSTALL_DIRS@
do
    install_args="${install_args} --find-links=${dir}"
done

version_spec=
if [ -n "${wheel_version}" ]
then
    version_spec="==${wheel_version}"
fi


create_venv()
{
    mkdir -p "${venv_path}"
    virtualenv ${venv_args} "${venv_path}"
    "${venv_path}/bin/pip" install ${install_args} "${wheel_name}${version_spec}"
}

add_symlinks()
{
    if [ -n "${symlinks_target_dir}" ]
    then
        for symlink in ${symlinks}
        do
            if [ -e "${symlinks_source_dir}/${symlink}" ]
            then
                ln -nsft "${symlinks_target_dir}" "${symlinks_source_dir}/${symlink}"
            fi
        done
    fi
}


case "$1" in
    configure)
        create_venv
        add_symlinks
        ;;
esac
